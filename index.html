<!DOCTYPE html>
<html>
<head>
  <title>Simple Local RAG</title>
  <style>
    :root {
      color-scheme: light;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Roboto, Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 16px;
      background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
      color: #0f172a;
    }

    .app-shell {
      width: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 24px 32px 28px;
    }

    .app-header {
      margin-bottom: 16px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 36px;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }

    .app-header p {
      margin: 8px 0 0;
      font-size: 18px;
      color: #475569;
      line-height: 1.5;
    }

    .panel,
    .response-card {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
    }

    .panel {
      padding: 24px;
    }

    .response-card {
      margin-top: 16px;
      padding: 18px 20px;
    }

    .response-card h3 {
      margin: 0 0 10px;
      font-size: 22px;
      color: #334155;
    }

    button {
      margin-top: 10px;
      padding: 12px 18px;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: #ffffff;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    button:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    textarea,
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      margin-top: 8px;
      padding: 13px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 16px;
      background: #ffffff;
      color: #0f172a;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea {
      min-height: 150px;
      resize: vertical;
    }

    textarea:focus,
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    #response {
      min-height: 140px;
      padding: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 16px;
      color: #1e293b;
    }

    .loading {
      font-style: italic;
      color: #475569;
    }

    .success {
      color: #065f46;
      font-weight: 600;
    }

    .error {
      color: #b91c1c;
      font-weight: 600;
    }

    h2 {
      margin: 2px 0 8px;
      font-size: 30px;
      line-height: 1.25;
      letter-spacing: -0.01em;
    }

    p {
      margin: 0 0 16px;
      font-size: 17px;
      color: #475569;
      line-height: 1.5;
    }

    .field {
      margin-bottom: 12px;
    }

    .field label,
    #askSection > label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 2px;
    }

    .checkbox-row {
      margin: 10px 0 4px;
      font-size: 16px;
      color: #334155;
    }

    .checkbox-row label {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tab-btn {
      margin-top: 0;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      color: #1e40af;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 16px;
    }

    .tab-btn.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #2563eb;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .actions-row {
      margin-top: 4px;
    }

    #ingestStatus {
      margin-top: 10px;
      min-height: 20px;
      font-size: 16px;
    }

    @media (max-width: 640px) {
      .app-shell {
        padding: 16px 14px 18px;
      }

      .app-header h1 {
        font-size: 30px;
      }

      h2 {
        font-size: 26px;
      }

      .tabs {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <h1>Simple Local RAG</h1>
      <p>Ingest repository content and ask focused questions with optional direct model mode.</p>
    </header>

    <section class="panel">
      <div class="tabs">
        <button id="ingestTabBtn" class="tab-btn" type="button" onclick="switchTab('ingest')">üì• Ingest</button>
        <button id="askTabBtn" class="tab-btn active" type="button" onclick="switchTab('ask')">‚ùì Ask</button>
      </div>

      <div id="ingestSection" class="tab-content">
        <h2>üì• Ingest Document</h2>
        <p>Choose a local folder and tag, then ingest chunks into your local vector store.</p>
        <div class="field">
          <label for="folderPath">Folder path</label>
          <input id="folderPath" type="text" value="/absolute/path/to/your/repo" />
        </div>
        <div class="field">
          <label for="repoTagInput">Repo tag</label>
          <input id="repoTagInput" type="text" value="my-repo" />
        </div>
        <div class="actions-row">
          <button id="ingestBtn" onclick="ingestFolder()">Ingest Folder</button>
        </div>
        <div id="ingestStatus"></div>
      </div>

      <div id="askSection" class="tab-content active">
        <h2>‚ùì Ask Question</h2>
        <p>Ask across all ingested content, filter by repo tag, or skip RAG and query the model directly.</p>
        <label for="repoTagSelect">Repository scope</label>
        <select id="repoTagSelect">
          <option value="">All repositories</option>
        </select>
        <div class="checkbox-row">
          <label>
            <input id="skipRagToggle" type="checkbox" />
            Skip local RAG context and ask model directly
          </label>
        </div>
        <textarea id="question" placeholder="Ask something about your code or docs..."></textarea>
        <div class="actions-row">
          <button id="askBtn" onclick="ask()">Ask</button>
        </div>
      </div>
    </section>

    <section class="response-card">
      <h3>Response</h3>
      <div id="response"></div>
    </section>
  </div>

  <script>
    function switchTab(tab) {
      const isIngestTab = tab === "ingest";
      const ingestSection = document.getElementById("ingestSection");
      const askSection = document.getElementById("askSection");
      const ingestTabBtn = document.getElementById("ingestTabBtn");
      const askTabBtn = document.getElementById("askTabBtn");

      ingestSection.classList.toggle("active", isIngestTab);
      askSection.classList.toggle("active", !isIngestTab);
      ingestTabBtn.classList.toggle("active", isIngestTab);
      askTabBtn.classList.toggle("active", !isIngestTab);
    }

    async function loadRepoTags() {
      const repoTagSelect = document.getElementById("repoTagSelect");

      try {
        const res = await fetch("/repo-tags");
        const data = await res.json();
        const repoTags = Array.isArray(data.repoTags) ? data.repoTags : [];

        repoTagSelect.innerHTML = '<option value="">All repositories</option>';
        for (const tag of repoTags) {
          const option = document.createElement("option");
          option.value = tag;
          option.textContent = tag;
          repoTagSelect.appendChild(option);
        }
      } catch (error) {
        repoTagSelect.innerHTML = '<option value="">All repositories</option>';
      }
    }

    function buildIngestPayloadFromFields() {
      return {
        folderPath: document.getElementById("folderPath").value.trim(),
        repoTag: document.getElementById("repoTagInput").value.trim(),
        extensions: [".js", ".ts", ".jsx", ".tsx", ".vue", ".json", ".md", ".html", ".css", ".scss", ".py", ".java", ".cs"],
        maxFiles: 2000,
        chunkSize: 3000,
        chunkOverlap: 200,
        dryRun: false
      };
    }

    async function ingestFolder() {
      const responseDiv = document.getElementById("response");
      const ingestStatus = document.getElementById("ingestStatus");
      const ingestBtn = document.getElementById("ingestBtn");
      const payload = buildIngestPayloadFromFields();

      if (!payload.folderPath) {
        alert("Folder path is required");
        return;
      }

      ingestBtn.disabled = true;
      ingestStatus.className = "loading";
      ingestStatus.innerText = "Ingest in progress...";
      responseDiv.innerText = "";

      try {
        const res = await fetch("/ingest/folder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        responseDiv.innerText = JSON.stringify(data, null, 2);

        if (res.ok) {
          ingestStatus.className = "success";
          ingestStatus.innerText = "Ingest completed successfully.";
          if (!payload.dryRun) {
            await loadRepoTags();
          }
        } else {
          ingestStatus.className = "error";
          ingestStatus.innerText = data.error || "Ingest failed.";
        }
      } catch (error) {
        ingestStatus.className = "error";
        ingestStatus.innerText = "Ingest failed due to network/server error.";
      } finally {
        ingestBtn.disabled = false;
      }
    }

    async function ask() {
      const question = document.getElementById("question").value;
      const selectedRepoTag = document.getElementById("repoTagSelect").value;
      const skipRag = document.getElementById("skipRagToggle").checked;
      const responseDiv = document.getElementById("response");
      const askBtn = document.getElementById("askBtn");

      if (!question) {
        alert("Please enter a question");
        return;
      }

      askBtn.disabled = true;
      responseDiv.innerHTML = '<span class="loading">Thinking...</span>';

      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question,
            repoTag: selectedRepoTag || undefined,
            skipRag,
          })
        });

        const data = await res.json();

        responseDiv.innerText = data.answer || data.error;
      } catch (error) {
        responseDiv.innerText = "Error occurred while processing request.";
      } finally {
        askBtn.disabled = false;
      }
    }

    function updateRepoScopeState() {
      const skipRagToggle = document.getElementById("skipRagToggle");
      const repoTagSelect = document.getElementById("repoTagSelect");
      const isDirectMode = skipRagToggle.checked;

      repoTagSelect.disabled = isDirectMode;
      repoTagSelect.title = isDirectMode
        ? "Repository scope is ignored when asking the model directly"
        : "";
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadRepoTags();
      const skipRagToggle = document.getElementById("skipRagToggle");
      skipRagToggle.addEventListener("change", updateRepoScopeState);
      updateRepoScopeState();
    });
  </script>
</body>
</html>
